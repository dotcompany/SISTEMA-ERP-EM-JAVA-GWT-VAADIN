package dc.visao.suprimentos.compra;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.event.FieldEvents.BlurEvent;
import com.vaadin.event.FieldEvents.BlurListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Component;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.Field;
import com.vaadin.ui.GridLayout;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TableFieldFactory;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

import dc.entidade.suprimentos.CotacaoDetalhe;
import dc.entidade.suprimentos.FornecedorCotacao;
import dc.visao.framework.component.SubFormComponent;
import dc.visao.framework.util.ComponentUtil;

public class ConfirmaCotacaoFormView extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private GridLayout fields;
	@AutoGenerated
	private TextField txtDescricao;
	@AutoGenerated
	private PopupDateField calDataCotacao;
	@AutoGenerated
	private ComboBox cmbFornecedor;
	@AutoGenerated
	private TextField txtPrazoEntrega;
	@AutoGenerated
	private TextField txtCondicaoPagamento;
	@AutoGenerated
	private TextField txtSubtotal;
	@AutoGenerated
	private TextField txtTaxaDesconto;
	@AutoGenerated
	private TextField txtValorDesconto;
	@AutoGenerated
	private TextField txtTotal;

	private SubFormComponent<CotacaoDetalhe, Integer> cotacaoDetalheSubForm;

	public ConfirmaCotacaoFormView() {
		buildMainLayout();
		setCompositionRoot(mainLayout);
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		setSizeFull();
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setSizeFull();
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);
		setWidth("100.0%");

		// fields
		fields = buildFields();
		fields.setRowExpandRatio(1, .15f);
		fields.setRowExpandRatio(2, .15f);
		fields.setRowExpandRatio(3, .15f);
		fields.setRowExpandRatio(4, 1);
		mainLayout.addComponent(fields);

		return mainLayout;
	}

	@AutoGenerated
	private GridLayout buildFields() {
		// common part: create layout
		fields = new GridLayout();
		fields.setImmediate(false);
		fields.setSizeFull();
		fields.setMargin(false);
		fields.setSpacing(true);
		fields.setColumns(6);
		fields.setRows(5);

		// calDataCotacao
		calDataCotacao = new PopupDateField();
		calDataCotacao.setCaption("Data da cotação");
		calDataCotacao.setImmediate(false);
		fields.addComponent(calDataCotacao, 0, 0);

		// txtDescricao
		txtDescricao = ComponentUtil.buildTextField("Descrição");
		fields.addComponent(txtDescricao, 1, 0, 5, 0);

		cmbFornecedor = ComponentUtil.buildComboBox("Fornecedores");
		cmbFornecedor
				.setInputPrompt("Selecione um fornecedor para ver os dados abaixo...");
		cmbFornecedor.addValueChangeListener(new ValueChangeListener() {

			private FornecedorCotacao oldValue;

			@Override
			public void valueChange(ValueChangeEvent event) {
				FornecedorCotacao fornCotacao = (FornecedorCotacao) cmbFornecedor
						.getValue();
				if (oldValue != null) {
					oldValue.setPrazoEntrega(txtPrazoEntrega.getValue());
					oldValue.setVendaCondicoesPagamento(txtCondicaoPagamento
							.getValue());
					oldValue.setValorSubtotal((BigDecimal) txtSubtotal
							.getConvertedValue());
					oldValue.setTaxaDesconto((BigDecimal) txtTaxaDesconto
							.getConvertedValue());
					oldValue.setValorDesconto((BigDecimal) txtValorDesconto
							.getConvertedValue());
					oldValue.setTotal((BigDecimal) txtTotal.getConvertedValue());
				}

				if (fornCotacao != null) {
					fillReqCotacaoDetalhesSubForm(fornCotacao
							.getCotacaoDetalhes());
					txtPrazoEntrega.setValue(fornCotacao.getPrazoEntrega());
					txtCondicaoPagamento.setValue(fornCotacao
							.getVendaCondicoesPagamento());
					txtSubtotal.setConvertedValue(fornCotacao
							.getValorSubtotal());
					txtTaxaDesconto.setConvertedValue(fornCotacao
							.getTaxaDesconto());
					txtValorDesconto.setConvertedValue(fornCotacao
							.getValorDesconto());
					txtTotal.setConvertedValue(fornCotacao.getTotal());
				} else {
					fillReqCotacaoDetalhesSubForm(new ArrayList<CotacaoDetalhe>(
							0));
					txtPrazoEntrega.setValue(null);
					txtCondicaoPagamento.setValue(null);
					txtSubtotal.setValue(null);
					txtTaxaDesconto.setValue(null);
					txtValorDesconto.setValue(null);
					txtTotal.setValue(null);
				}
				oldValue = fornCotacao;
			}
		});
		fields.addComponent(cmbFornecedor, 0, 1, 5, 1);

		txtPrazoEntrega = ComponentUtil.buildTextField("Prazo de Entrega");
		fields.addComponent(txtPrazoEntrega, 0, 2, 1, 2);

		txtCondicaoPagamento = ComponentUtil
				.buildTextField("condição de Pagamento");
		fields.addComponent(txtCondicaoPagamento, 2, 2, 3, 2);

		txtSubtotal = ComponentUtil.buildCurrencyField("Subtotal");
		fields.addComponent(txtSubtotal, 4, 2, 5, 2);

		txtTaxaDesconto = ComponentUtil.buildNumberField("Taxa de Desconto");
		fields.addComponent(txtTaxaDesconto, 0, 3, 1, 3);

		txtValorDesconto = ComponentUtil
				.buildCurrencyField("Valor de Desconto");
		fields.addComponent(txtValorDesconto, 2, 3, 3, 3);

		txtTotal = ComponentUtil.buildCurrencyField("Total");
		fields.addComponent(txtTotal, 4, 3, 5, 3);

		cotacaoDetalheSubForm = new SubFormComponent<CotacaoDetalhe, Integer>(
				CotacaoDetalhe.class, new String[] { "produto.nome",
						"quantidade", "valorUnitario", "valorSubtotal",
						"taxaDesconto", "valorDesconto", "valorTotal" },
				new String[] { "Produto requisitado", "Quantidade",
						"Valor Unitário", "Valor SubTotal", "Taxa Desconto",
						"Valor Desconto", "Valor Total" }, new String[] {
						"valorSubtotal", "valorDesconto", "valorTotal" }) {
			@Override
			protected TableFieldFactory getFieldFactory() {
				return new TableFieldFactory() {

					@Override
					public Field<?> createField(Container container,
							Object itemId, Object propertyId,
							Component uiContext) {
						if ("quantidade".equals(propertyId)
								|| "produto.nome".equals(propertyId)) {
							TextField textField = ComponentUtil
									.buildTextField(null);
							textField.setReadOnly(true);
							return textField;
						} else if ("valorUnitario".equals(propertyId)
								|| "valorDesconto".equals(propertyId)) {
							TextField buildCurrencyField = ComponentUtil
									.buildCurrencyField(null);
							buildCurrencyField.addBlurListener(getBlurListener(
									container, itemId, propertyId));
							return buildCurrencyField;
						} else if ("valorSubtotal".equals(propertyId)
								|| "valorTotal".equals(propertyId)) {
							TextField buildCurrencyField = ComponentUtil
									.buildCurrencyField(null);
							buildCurrencyField.setReadOnly(true);
							buildCurrencyField.addBlurListener(getBlurListener(
									container, itemId, propertyId));
							return buildCurrencyField;
						}
						return ComponentUtil.buildNumberField(null);
					}

					private BlurListener getBlurListener(
							final Container container, final Object itemId,
							final Object propertyId) {
						return new BlurListener() {
							@Override
							public void blur(BlurEvent event) {
								Property<BigDecimal> quantidade = get("quantidade");
								Property<BigDecimal> valorUnitario = get("valorUnitario");
								Property<BigDecimal> valorSubtotal = get("valorSubtotal");
								Property<BigDecimal> valorDesconto = get("valorDesconto");
								Property<BigDecimal> valorTotal = get("valorTotal");

								if (quantidade.getValue() != null
										&& valorUnitario.getValue() != null) {
									BigDecimal q = quantidade.getValue();
									BigDecimal vu = valorUnitario.getValue();
									valorSubtotal.setValue(q.multiply(vu));
								}

								if (valorSubtotal.getValue() != null) {
									BigDecimal vs = valorSubtotal.getValue();
									BigDecimal vd = BigDecimal.ZERO;
									if (valorDesconto.getValue() != null) {
										vd = valorDesconto.getValue();
									} else {
										valorDesconto.setValue(BigDecimal.ZERO);
									}
									valorTotal.setValue(vs.subtract(vd));
								}
							}

							@SuppressWarnings("unchecked")
							private Property<BigDecimal> get(String property) {
								Item item = container.getItem(itemId);
								return item.getItemProperty(property);
							}
						};
					}
				};
			}

			@Override
			protected CotacaoDetalhe getNovo() {
				throw new UnsupportedOperationException(
						"Não é possível criar novo!");
			}

			@Override
			protected void getRemoverSelecionados(List<CotacaoDetalhe> values) {
				throw new UnsupportedOperationException(
						"Não é possível remover!");
			}

			@Override
			public boolean validateItems(List<CotacaoDetalhe> items) {
				return false;
			}
		};
		cotacaoDetalheSubForm.setReadOnly(true);
		fields.addComponent(cotacaoDetalheSubForm, 0, 4, 5, 4);

		return fields;
	}

	public TextField getTxtDescricao() {
		return txtDescricao;
	}

	public PopupDateField getCalDataCotacao() {
		return calDataCotacao;
	}

	public void fillReqCotacaoDetalhesSubForm(
			List<CotacaoDetalhe> requisicaoDetalhes) {
		cotacaoDetalheSubForm.fillWith(requisicaoDetalhes);
	}

	public void fillCompraFornecedorCotacoesSubForm(
			List<FornecedorCotacao> lista) {
		BeanItemContainer<FornecedorCotacao> tipoRequisicaoContainer = new BeanItemContainer<>(
				FornecedorCotacao.class, lista);
		tipoRequisicaoContainer
				.addNestedContainerProperty("fornecedor.pessoa.nome");
		cmbFornecedor.setContainerDataSource(tipoRequisicaoContainer);
		cmbFornecedor.setItemCaptionPropertyId("fornecedor.pessoa.nome");
	}

}