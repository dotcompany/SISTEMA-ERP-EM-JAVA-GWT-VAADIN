package dc.visao.suprimentos;

import java.util.List;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.util.BeanContainer;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Component;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.Field;
import com.vaadin.ui.GridLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TableFieldFactory;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

import dc.entidade.pessoal.Colaborador;
import dc.entidade.produto.Produto;
import dc.entidade.suprimentos.RequisicaoDetalhe;
import dc.entidade.suprimentos.TipoRequisicao;
import dc.visao.framework.component.LookupComponent;
import dc.visao.framework.component.SubFormComponent;
import dc.visao.framework.util.ComponentUtil;

public class RequisicaoCompraFormView extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	private static final long serialVersionUID = 6360941679958563318L;

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private GridLayout fields;
	@AutoGenerated
	private Label lblId;
	@AutoGenerated
	private PopupDateField calDataRequisicao;
	@AutoGenerated
	private LookupComponent<Integer, Colaborador> lkpRequisitante;
	@AutoGenerated
	private ComboBox cmbTipoRequisicao;

	private RequisicaoCompraFormController controller;

	private SubFormComponent<RequisicaoDetalhe, Integer> requisicaoDetalheSubForm;

	public RequisicaoCompraFormView(RequisicaoCompraFormController controller) {
		this.controller = controller;
		buildMainLayout();
		setCompositionRoot(mainLayout);
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		setSizeFull();
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setSizeFull();
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);

		// top-level component properties
		setWidth("100.0%");
//		setHeight("100.0%");

		// fields
		fields = buildFields();
		mainLayout.addComponent(fields);

		// subForm
		mainLayout.addComponent(buildSubForms());
		mainLayout.setExpandRatio(requisicaoDetalheSubForm, 1);

		return mainLayout;
	}

	public PopupDateField getCalDataRequisicao() {
		return calDataRequisicao;
	}

	public LookupComponent<Integer, Colaborador> getLkpRequisitante() {
		return lkpRequisitante;
	}

	public ComboBox getCmbTipoRequisicao() {
		return cmbTipoRequisicao;
	}

	@AutoGenerated
	private GridLayout buildFields() {
		// common part: create layout
		fields = new GridLayout(6, 1);
		fields.setImmediate(false);
		fields.setWidth("100.0%");
		fields.setHeight("-1px");
		fields.setMargin(false);
		fields.setSpacing(true);

		// lblId
		lblId = new Label();
		lblId.setCaption("Id");
		lblId.setImmediate(false);
		lblId.setSizeFull();
		fields.addComponent(lblId, 0, 0);

		// cmbTipoRequisicao
		cmbTipoRequisicao = ComponentUtil.buildComboBox("Tipo de Requisi�ao");
		fields.addComponent(cmbTipoRequisicao, 1, 0);

		// lkpRequisitante
		lkpRequisitante = ComponentUtil.buildLookup("Id", "Requisitante");
		fields.addComponent(lkpRequisitante, 2, 0, 4, 0);

		// calDataRequisicao
		calDataRequisicao = new PopupDateField();
		calDataRequisicao.setCaption("Data Requisi�ao");
		calDataRequisicao.setImmediate(false);
		fields.addComponent(calDataRequisicao, 5, 0);

		return fields;
	}

	@AutoGenerated
	@SuppressWarnings("serial")
	private SubFormComponent<?, ?> buildSubForms() {
		requisicaoDetalheSubForm = new SubFormComponent<RequisicaoDetalhe, Integer>(RequisicaoDetalhe.class, new String[] { "produto",
				"quantidade" }, new String[] { "Produto", "Quantidade" }) {
			@Override
			protected TableFieldFactory getFieldFactory() {
				return new TableFieldFactory() {

					@Override
					public Field<?> createField(Container container, Object itemId, Object propertyId, Component uiContext) {
						if ("produto".equals(propertyId)) {
							ComboBox comboBox = ComponentUtil.buildComboBox(null);
							BeanItemContainer<Produto> produtoContainer = new BeanItemContainer<>(Produto.class,
									controller.buscarProdutos());
							comboBox.setContainerDataSource(produtoContainer);
							comboBox.setItemCaptionPropertyId("descricao");
							return comboBox;
						} else if ("quantidade".equals(propertyId)) {
							TextField textField = ComponentUtil.buildNumberField(null);
							return textField;
						}
						return null;
					}
				};
			}

			protected RequisicaoDetalhe getNovo() {
				RequisicaoDetalhe requisicaoDetalhe = controller.novoRequisicaoDetalhe();
				return requisicaoDetalhe;
			}

			protected void getRemoverSelecionados(List<RequisicaoDetalhe> values) {
				controller.removerRequisicaoDetalhes(values);
			}

			@Override
			public boolean validateItems(List<RequisicaoDetalhe> items) {
				for (RequisicaoDetalhe requisicaoDetalhe : items) {
					if (requisicaoDetalhe.getProduto() == null ||
							requisicaoDetalhe.getQuantidade() == null) {
						return false;
					}
				}
				return true;
			}
		};

		return requisicaoDetalheSubForm;
	}

	public void fillCmbTipoRequisicao(List<TipoRequisicao> lista) {
		BeanItemContainer<TipoRequisicao> tipoRequisicaoContainer = new BeanItemContainer<>(TipoRequisicao.class, lista);
		cmbTipoRequisicao.setContainerDataSource(tipoRequisicaoContainer);
		cmbTipoRequisicao.setItemCaptionPropertyId("descricao");
	}

	public void fillCmbRequisitante(List<Colaborador> lista) {
		BeanContainer<Integer, Colaborador> tipoRequisicaoContainer = lkpRequisitante.createContainer(Colaborador.class);
		tipoRequisicaoContainer.addNestedContainerProperty("pessoa.nome");
		tipoRequisicaoContainer.addAll(lista);
		lkpRequisitante.setItemCaptionPropertyId("pessoa.nome");
	}

	public void fillRequisicaoDetalhesSubForm(List<RequisicaoDetalhe> requisicaoDetalhes) {
		requisicaoDetalheSubForm.fillWith(requisicaoDetalhes);
	}

	public Label getLblId() {
		return lblId;
	}

}
